name: SSL - Setup

on:
  workflow_dispatch:

jobs:
  setup_ssl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: SSH into server and install dependencies
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "Updating package lists..."
            sudo apt update -q
            
            echo "Checking if Nginx is installed..."
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt install -y nginx
            fi

            echo "Checking if Certbot is installed..."
            if ! command -v certbot &> /dev/null; then
              echo "Installing Certbot..."
              sudo apt install -y certbot python3-certbot-nginx
            fi
          EOF

      - name: Obtain and Install SSL Certificate
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "Requesting SSL certificate for ${{ secrets.DOMAIN_NAME }}..."
            sudo certbot --nginx \
              -d ${{ secrets.DOMAIN_NAME }} \
              --agree-tos \
              --email ${{ secrets.SSL_EMAIL }} \
              --no-eff-email \
              --redirect \
              --non-interactive || { echo "Certbot failed!"; exit 1; }
          EOF

      - name: Check for certificate issuance
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            CERT_PATH="/etc/letsencrypt/live/${{ secrets.DOMAIN_NAME }}/fullchain.pem"
            if [ -f "$CERT_PATH" ]; then
              echo "✅ SSL certificate obtained successfully."
            else
              echo "❌ Failed to obtain SSL certificate."
              exit 1
            fi
          EOF

      - name: Restart Nginx
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "Restarting Nginx..."
            sudo systemctl restart nginx
            echo "Nginx restarted successfully."
          EOF

      - name: Verify Nginx Configuration
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "Checking Nginx configuration..."
            sudo nginx -t
          EOF

      - name: Add Auto-Renewal Cron Job
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            echo "Setting up automatic SSL renewal..."
            (sudo crontab -l 2>/dev/null | grep -v certbot; echo "0 3 * * * certbot renew --quiet --post-hook 'systemctl restart nginx'") | sudo crontab -
            echo "Auto-renewal job added."
          EOF