services:
  adguard-home:
    env_file:
      - .env
    container_name: adguard-home
    hostname: adguard-home
    image: adguard/adguardhome:latest
    # Bridge networking - AdGuard serves local network DNS & ad-blocking
    ports:
      - "${ADGUARD_DNS_TCP}:53/tcp"       # DNS
      - "${ADGUARD_DNS_UDP}:53/udp"       # DNS
      - "${ADGUARD_SETUP_PORT}:3000/tcp"  # Initial setup (disable after first run)
      - "${ADGUARD_WEB_PORT}:80/tcp"      # Web interface
      - "${ADGUARD_HTTPS_PORT}:443/tcp"   # HTTPS/DNS-over-HTTPS
      - "${ADGUARD_DOT_PORT}:853/tcp"     # DNS-over-TLS
    volumes:
      - /srv/docker/adguard/work:/opt/adguardhome/work
      - /srv/docker/adguard/conf:/opt/adguardhome/conf
      - /srv/docker/adguard/certs:/opt/adguardhome/certs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    stop_grace_period: 10s
